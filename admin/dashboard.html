<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin — My Inner circle</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../styles.css" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><circle fill='%23c97082' cx='16' cy='16' r='14'/></svg>" type="image/svg+xml" />
  <style>
    .admin-header { display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 0.5rem; }
    .admin-header .logo { font-size: 1.25rem; font-weight: 600; }
    .admin-nav { display: flex; align-items: center; gap: 0.5rem; }
    .admin-nav a, .admin-nav span { padding: 0.4rem 0.75rem; font-size: 0.9rem; color: var(--text-muted); text-decoration: none; border-radius: 8px; }
    .admin-nav a:hover, .admin-nav span.active { color: var(--accent); background: var(--accent-soft); }
    .admin-main { max-width: 1100px; margin: 0 auto; padding: 2rem 1.5rem; }
    .section-top { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
    .section-top h1 { font-size: 1.35rem; margin: 0; }
    .admin-search { padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem; width: 100%; max-width: 280px; }
    .admin-search::placeholder { color: var(--text-muted); }
    .add-member { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; }
    .add-member h2 { font-size: 1.1rem; margin: 0 0 1rem; }
    .add-member label { display: block; margin-bottom: 0.35rem; font-weight: 500; font-size: 0.9rem; }
    .add-member input { width: 100%; max-width: 280px; padding: 0.6rem; margin-bottom: 0.75rem; border: 1px solid var(--border); border-radius: 8px; }
    .add-member .btn { margin-right: 0.5rem; margin-top: 0.25rem; }
    .members-table-wrap { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch; }
    .members-table { width: 100%; min-width: 760px; border-collapse: collapse; font-size: 0.9rem; }
    .members-table th { text-align: left; padding: 0.85rem 1rem; font-weight: 600; color: var(--text-muted); border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.03); }
    .members-table td { padding: 0.85rem 1rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
    .members-table tbody tr:last-child td { border-bottom: none; }
    .members-table tbody tr.cancelled { opacity: 0.7; }
    .members-table tbody tr:hover { background: rgba(0,0,0,0.02); }
    .user-cell { display: flex; align-items: center; gap: 0.75rem; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), #a855f7); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.95rem; flex-shrink: 0; }
    .user-info .user-name { font-weight: 500; display: block; }
    .user-info .user-email { font-size: 0.85rem; color: var(--text-muted); }
    .plan-badge { display: inline-block; padding: 0.25rem 0.6rem; border-radius: 999px; font-size: 0.8rem; font-weight: 500; }
    .plan-badge.active { background: rgba(34, 197, 94, 0.15); color: #15803d; }
    .plan-badge.cancelled { background: var(--accent-soft); color: var(--accent-hover); }
    .action-links { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
    .action-links .link { color: var(--accent); background: none; border: none; cursor: pointer; font-size: 0.85rem; padding: 0; text-decoration: none; }
    .action-links .link:hover { text-decoration: underline; }
    .action-links .link.danger { color: #dc2626; }
    .btn-icon { background: none; border: none; cursor: pointer; padding: 0.35rem; color: var(--text-muted); border-radius: 6px; display: inline-flex; align-items: center; justify-content: center; }
    .btn-icon:hover { color: #dc2626; background: rgba(220, 38, 38, 0.08); }
    .btn-icon svg { width: 18px; height: 18px; }
    .loading, .empty { color: var(--text-muted); padding: 2rem; text-align: center; }
    .tips-section { margin-top: 1.5rem; }
    .tips-table-wrap { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch; }
    .tips-table { width: 100%; min-width: 640px; border-collapse: collapse; font-size: 0.9rem; }
    .tips-table th { text-align: left; padding: 0.85rem 1rem; font-weight: 600; color: var(--text-muted); border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.03); }
    .tips-table td { padding: 0.85rem 1rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
    .tips-table tbody tr:last-child td { border-bottom: none; }
    .tips-empty { color: var(--text-muted); padding: 1rem; text-align: center; }
    .btn-logout { font-size: 0.9rem; color: var(--text-muted); background: none; border: none; cursor: pointer; padding: 0.4rem 0.75rem; border-radius: 8px; }
    .btn-logout:hover { color: var(--accent); }
  </style>
</head>
<body>
  <header class="admin-header">
    <span class="logo">Admin Dashboard</span>
    <nav class="admin-nav">
      <a href="../index.html">Home</a>
      <span class="active">Dashboard</span>
      <a href="users.html">User Management</a>
      <a href="media.html">Media</a>
      <a href="content.html">Content</a>
      <a href="posts.html">Posts</a>
      <button type="button" id="btn-logout" class="btn-logout">Log out</button>
    </nav>
  </header>

  <main class="admin-main">
    <p style="background: var(--accent-soft); border: 1px solid var(--accent); border-radius: 12px; padding: 0.75rem 1rem; margin-bottom: 1.5rem; font-size: 0.9rem;">Admin panel: <strong>Dashboard</strong> (here), <strong><a href="users.html">User Management</a></strong> (who can access admin), <strong><a href="media.html">Media</a></strong>, <strong><a href="content.html">Content</a></strong>, <strong><a href="posts.html">Posts</a></strong>.</p>
    <section class="add-member">
      <h2>Add member manually</h2>
      <p class="meta" style="margin-bottom: 1rem;">Signup date is set automatically when you add a fan.</p>
      <form id="add-form">
        <label for="new-email">Email</label>
        <input type="email" id="new-email" placeholder="member@example.com" required />
        <label for="new-note">Instagram handle</label>
        <input type="text" id="new-note" placeholder="@username" />
        <button type="submit" class="btn btn-primary">Add</button>
      </form>
      <p id="add-member-status" style="font-size:0.9rem;margin-top:0.5rem;min-height:1.5rem;"></p>
    </section>

    <div class="section-top">
      <h1>User Management</h1>
      <input type="search" id="search-members" class="admin-search" placeholder="Search by username or email…" />
    </div>

    <div class="members-table-wrap">
      <table class="members-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Signup Date</th>
            <th>Cancel Date</th>
            <th>Remove from CF by</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="members-tbody"></tbody>
      </table>
    </div>
    <p id="loading" class="loading">Loading members…</p>
    <p id="empty" class="empty" style="display:none;">No members yet. Add one above or they’ll appear when someone pays via Stripe.</p>

    <section class="tips-section">
      <div class="section-top" style="margin-bottom: 0.75rem;">
        <h2 style="font-size: 1.15rem; margin: 0;">Recent Tips</h2>
      </div>
      <div class="tips-table-wrap" id="tips-table-wrap" style="display:none;">
        <table class="tips-table">
          <thead>
            <tr>
              <th>When</th>
              <th>Amount</th>
              <th>Email</th>
              <th>Instagram</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="tips-tbody"></tbody>
        </table>
      </div>
      <p id="tips-empty" class="tips-empty">No tips logged yet.</p>
    </section>
  </main>

  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="../firebase-config.js"></script>
  <script src="admin-auth.js"></script>
  <script>
    if (typeof FIREBASE_CONFIG === "undefined" || !FIREBASE_CONFIG.apiKey || FIREBASE_CONFIG.apiKey === "YOUR_API_KEY") {
      document.body.innerHTML = "<main class='admin-main'><h1>Firebase not configured</h1><p>Edit <code>firebase-config.js</code> and add your config.</p></main>";
    } else {
      firebase.initializeApp(FIREBASE_CONFIG);
      var auth = firebase.auth();
      var db = firebase.firestore();

      ensureAdminAccess(function(user) {
        if (!user) return;
        loadMembers();
        loadTips();
      });

      document.getElementById("btn-logout").addEventListener("click", function() {
        auth.signOut();
      });

      var membersCache = [];
      document.getElementById("search-members").addEventListener("input", function() {
        renderMembers();
      });

      function renderMembers() {
        var searchQuery = (document.getElementById("search-members").value || "").trim().toLowerCase();
        var tbody = document.getElementById("members-tbody");
        var emptyEl = document.getElementById("empty");
        var tableWrap = document.querySelector(".members-table-wrap");
        var filtered = searchQuery
          ? membersCache.filter(function(o) {
              var d = o.data;
              var email = (d.email || "").toLowerCase();
              var ig = (d.instagram_handle || d.note || "").toLowerCase();
              return email.indexOf(searchQuery) !== -1 || ig.indexOf(searchQuery) !== -1;
            })
          : membersCache;

        tbody.innerHTML = "";
        if (filtered.length === 0) {
          tableWrap.style.display = "none";
          emptyEl.style.display = "block";
          emptyEl.textContent = searchQuery ? "No members match your search." : "No members yet. Add one above or they'll appear when someone pays via Stripe.";
          return;
        }
        tableWrap.style.display = "block";
        emptyEl.style.display = "none";

        filtered.forEach(function(o) {
          var d = o.data;
          var joined = d.joinedAt && d.joinedAt.toDate ? d.joinedAt.toDate().toLocaleDateString() : "—";
          var ig = d.instagram_handle || d.note || "—";
          var email = d.email || "—";
          var rawInitial = ig !== "—" ? ig.replace(/^@/, "").charAt(0) : (email !== "—" ? email.charAt(0) : "?");
          var initial = (rawInitial || "?").toUpperCase();
          var cancelStr = d.cancelledAt && d.cancelledAt.toDate ? d.cancelledAt.toDate().toLocaleDateString() : "—";
          var status = d.status || "active";
          var removeByStr = "—";
          if (status === "cancelled" && d.access_ends_at && d.access_ends_at.toDate) {
            var end = d.access_ends_at.toDate();
            var now = new Date();
            var daysLeft = Math.max(0, Math.ceil((end - now) / (24 * 60 * 60 * 1000)));
            removeByStr = end.toLocaleDateString() + (daysLeft > 0 ? " (" + daysLeft + " day(s) left)" : " — remove now");
          }
          var joinedMs = d.joinedAt && d.joinedAt.toDate ? d.joinedAt.toDate().getTime() : "";
          var actions = (status !== "cancelled" ? "<button type='button' class='link btn-mark-cancel' data-id='" + o.id + "' data-joined-ms='" + joinedMs + "'>Mark cancelled</button>" : "") +
            " <button type='button' class='btn-icon btn-delete' data-id='" + o.id + "' title='Delete'><svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16'/></svg></button>";
          var tr = document.createElement("tr");
          if (status === "cancelled") tr.className = "cancelled";
          tr.innerHTML =
            "<td><div class='user-cell'><div class='user-avatar'>" + initial + "</div><div class='user-info'><span class='user-name'>" + escapeHtml(ig) + "</span><span class='user-email'>" + escapeHtml(email) + "</span></div></div></td>" +
            "<td>" + joined + "</td>" +
            "<td>" + cancelStr + "</td>" +
            "<td>" + removeByStr + "</td>" +
            "<td><div class='action-links'>" + actions + "</div></td>";
          tbody.appendChild(tr);
        });

        tbody.querySelectorAll(".btn-mark-cancel").forEach(function(btn) {
          btn.addEventListener("click", function() {
            var accessEnd;
            var joinedMs = btn.dataset.joinedMs;
            if (joinedMs) {
              accessEnd = new Date(parseInt(joinedMs, 10));
              accessEnd.setDate(accessEnd.getDate() + 30);
            } else {
              accessEnd = new Date();
              accessEnd.setDate(accessEnd.getDate() + 30);
            }
            db.collection("members").doc(btn.dataset.id).update({
              status: "cancelled",
              cancelledAt: firebase.firestore.FieldValue.serverTimestamp(),
              access_ends_at: firebase.firestore.Timestamp.fromDate(accessEnd)
            });
          });
        });
        tbody.querySelectorAll(".btn-delete").forEach(function(btn) {
          btn.addEventListener("click", function() {
            if (confirm("Remove this member from the list? This cannot be undone.")) {
              db.collection("members").doc(btn.dataset.id).delete();
            }
          });
        });
      }

      function loadMembers() {
        var loadingEl = document.getElementById("loading");
        var emptyEl = document.getElementById("empty");

        db.collection("members")
          .orderBy("joinedAt", "desc")
          .onSnapshot(function(snap) {
            loadingEl.style.display = "none";
            membersCache = [];
            snap.forEach(function(doc) {
              membersCache.push({ id: doc.id, data: doc.data() });
            });
            renderMembers();
          }, function(err) {
            loadingEl.style.display = "none";
            emptyEl.textContent = "Error loading members: " + (err.message || "check Firestore rules");
            emptyEl.style.display = "block";
          });
      }

      function loadTips() {
        var tipsWrap = document.getElementById("tips-table-wrap");
        var tipsBody = document.getElementById("tips-tbody");
        var tipsEmpty = document.getElementById("tips-empty");
        db.collection("tips")
          .orderBy("tippedAt", "desc")
          .limit(100)
          .onSnapshot(function(snap) {
            tipsBody.innerHTML = "";
            if (snap.empty) {
              tipsWrap.style.display = "none";
              tipsEmpty.style.display = "block";
              tipsEmpty.textContent = "No tips logged yet.";
              return;
            }
            tipsWrap.style.display = "block";
            tipsEmpty.style.display = "none";
            snap.forEach(function(doc) {
              var d = doc.data() || {};
              var when = d.tippedAt && d.tippedAt.toDate ? d.tippedAt.toDate().toLocaleString() : "—";
              var amount = typeof d.amountCents === "number" ? "$" + (d.amountCents / 100).toFixed(2) : "—";
              var email = d.email || "—";
              var ig = d.instagram_handle || "—";
              var status = d.paymentStatus || "—";
              var tr = document.createElement("tr");
              tr.innerHTML =
                "<td>" + escapeHtml(when) + "</td>" +
                "<td>" + escapeHtml(amount) + "</td>" +
                "<td>" + escapeHtml(email) + "</td>" +
                "<td>" + escapeHtml(ig) + "</td>" +
                "<td>" + escapeHtml(status) + "</td>";
              tipsBody.appendChild(tr);
            });
          }, function(err) {
            tipsWrap.style.display = "none";
            tipsEmpty.style.display = "block";
            tipsEmpty.textContent = "Error loading tips: " + (err.message || "check Firestore rules");
          });
      }

      function escapeHtml(s) {
        var div = document.createElement("div");
        div.textContent = s;
        return div.innerHTML;
      }

      document.getElementById("add-form").addEventListener("submit", function(e) {
        e.preventDefault();
        var btn = e.target.querySelector('button[type="submit"]');
        var email = document.getElementById("new-email").value.trim();
        var note = document.getElementById("new-note").value.trim();
        var statusEl = document.getElementById("add-member-status");
        if (!email) {
          if (statusEl) { statusEl.textContent = "Email is required."; statusEl.style.color = "#dc2626"; }
          return;
        }
        btn.disabled = true;
        if (statusEl) statusEl.textContent = "Adding…";
        db.collection("members").add({
          email: email,
          note: note || null,
          instagram_handle: note || null,
          status: "active",
          joinedAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(function(ref) {
          document.getElementById("new-email").value = "";
          document.getElementById("new-note").value = "";
          btn.disabled = false;
          if (statusEl) { statusEl.textContent = "Member added. ID: " + ref.id; statusEl.style.color = "#15803d"; }
          setTimeout(function() { if (statusEl) statusEl.textContent = ""; }, 4000);
        }).catch(function(err) {
          btn.disabled = false;
          if (statusEl) { statusEl.textContent = "Error: " + (err.message || "check Firestore"); statusEl.style.color = "#dc2626"; }
          console.error("Members add error:", err);
        });
      });
    }
  </script>
</body>
</html>
