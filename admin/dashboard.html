<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin — My Inner circle</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../styles.css" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><circle fill='%23c97082' cx='16' cy='16' r='14'/></svg>" type="image/svg+xml" />
  <style>
    body { display: flex; flex-direction: column; min-height: 100vh; overflow-x: hidden; }
    .admin-header { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .admin-header-title { font-size: 1.25rem; font-weight: 600; color: var(--text); text-decoration: none; }
    .admin-header-title:hover { color: var(--accent); }
    .admin-header-right { display: flex; align-items: center; gap: 1rem; }
    .admin-header-right .header-link { display: flex; align-items: center; justify-content: center; color: var(--text-muted); text-decoration: none; padding: 0.5rem; border-radius: 8px; -webkit-tap-highlight-color: transparent; outline: none; }
    .admin-header-right .header-link:hover { color: var(--accent); background: var(--accent-soft); }
    .admin-header-right .header-link:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .admin-header-right .header-link svg { width: 1.25rem; height: 1.25rem; }
    .admin-header-profile { position: relative; }
    .admin-header-profile .profile-btn { width: 40px; height: 40px; min-width: 40px; min-height: 40px; padding: 0; border-radius: 50%; background: transparent; color: #fff; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1rem; line-height: 0; box-sizing: border-box; transition: box-shadow 0.2s; -webkit-tap-highlight-color: transparent; outline: none; overflow: hidden; }
    .admin-header-profile .profile-btn:hover { box-shadow: 0 0 0 2px var(--accent-soft); }
    .admin-header-profile .profile-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .admin-header-profile .profile-btn img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; object-position: center; border: 2px solid var(--border); box-sizing: border-box; display: block; }
    .admin-header-profile .profile-btn .profile-btn-default { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-hover)); border: 2px solid var(--border); box-sizing: border-box; line-height: 1; }
    .admin-header-profile .profile-dropdown { position: absolute; top: 100%; right: 0; margin-top: 0.5rem; min-width: 160px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 0.5rem; z-index: 50; display: none; }
    .admin-header-profile.open .profile-dropdown { display: block; }
    .admin-header-profile .profile-dropdown button,
    .admin-header-profile .profile-dropdown a { display: block; width: 100%; text-align: left; padding: 0.6rem 0.75rem; font-size: 0.9rem; color: var(--text-muted); background: none; border: none; cursor: pointer; border-radius: 6px; font-family: inherit; text-decoration: none; }
    .admin-header-profile .profile-dropdown button:hover,
    .admin-header-profile .profile-dropdown a:hover { color: var(--accent); background: var(--accent-soft); }
    .admin-tabs-bar { display: flex; justify-content: flex-end; align-items: center; padding: 0.75rem 2rem; background: var(--bg); flex-shrink: 0; gap: 0.35rem; }
    .admin-tabs-bar .tab { padding: 0.5rem 1rem; font-size: 0.9rem; color: var(--text-muted); text-decoration: none; border: 1px solid var(--border); background: var(--bg-card); cursor: pointer; font-family: inherit; border-radius: 8px; -webkit-tap-highlight-color: transparent; outline: none; }
    .admin-tabs-bar .tab:hover { color: var(--accent); border-color: var(--accent); background: var(--accent-soft); }
    .admin-tabs-bar .tab:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .admin-tabs-bar .tab.active { font-weight: 600; color: var(--accent); border-color: var(--accent); background: var(--accent-soft); }
    .admin-main { flex: 1; min-height: 0; overflow-x: hidden; overflow-y: auto; padding: 2.5rem 2rem; }
    .admin-main-inner { max-width: 1200px; margin: 0 auto; }
    .admin-main.custom-scrollbar { scrollbar-width: thin; }
    .admin-main.custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
    .admin-main.custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .admin-main.custom-scrollbar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    .admin-main .panel { display: none; }
    .admin-main .panel.active { display: block; }
    #panel-overview { background: linear-gradient(180deg, rgba(255,255,255,0.6) 0%, var(--bg) 12rem); border-radius: 16px; padding: 0.5rem 0 2rem; }
    .overview-section { margin-bottom: 2.75rem; }
    .overview-section-title { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 1rem; padding-left: 1rem; border-left: 3px solid var(--accent); }
    .overview-cards { display: flex; flex-wrap: wrap; gap: 1.25rem; }
    .stat-card { flex: 1; min-width: 160px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 1.5rem 1.75rem; box-shadow: 0 2px 8px rgba(201, 112, 130, 0.06); transition: box-shadow 0.2s ease, transform 0.2s ease; }
    .stat-card:hover { box-shadow: 0 8px 24px rgba(201, 112, 130, 0.12); transform: translateY(-2px); }
    .stat-card .label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.4rem; letter-spacing: 0.02em; }
    .stat-card .sublabel { font-size: 0.72rem; color: var(--text-muted); margin-top: 0.35rem; opacity: 0.9; }
    .stat-card .value { font-size: 1.75rem; font-weight: 600; letter-spacing: -0.02em; color: var(--text); }
    .stat-card.revenue-total { background: linear-gradient(135deg, #fff 0%, var(--accent-soft) 100%); border-color: rgba(201, 112, 130, 0.25); box-shadow: 0 4px 16px rgba(201, 112, 130, 0.15); }
    .stat-card.revenue-total .value { font-size: 2.25rem; font-weight: 700; color: var(--accent); letter-spacing: -0.03em; }
    .tools-list { display: flex; flex-direction: column; gap: 0.5rem; max-width: 320px; }
    .tools-list a { display: block; padding: 0.75rem 1rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; color: var(--accent); text-decoration: none; font-weight: 500; transition: background 0.2s, border-color 0.2s; }
    .tools-list a:hover { background: var(--accent-soft); border-color: rgba(201, 112, 130, 0.3); }
    .loading-stats { color: var(--text-muted); padding: 1rem 0; }
    .overview-layout { display: grid; grid-template-columns: 1fr; gap: 2rem; margin-top: 0; }
    @media (min-width: 900px) { .overview-layout { grid-template-columns: 1fr 300px; } }
    .recent-activity-card, .top-spenders-card, .top-purchases-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 1.5rem 1.75rem; box-shadow: 0 2px 12px rgba(0,0,0,0.04); transition: box-shadow 0.2s ease; }
    .recent-activity-card:hover, .top-spenders-card:hover, .top-purchases-card:hover { box-shadow: 0 6px 20px rgba(201, 112, 130, 0.08); }
    .recent-activity-card h2, .top-spenders-card h2, .top-purchases-card h2 { font-size: 1rem; font-weight: 600; margin: 0 0 1rem; color: var(--text); letter-spacing: -0.01em; }
    .recent-activity-list { display: flex; flex-direction: column; gap: 0; }
    .recent-activity-item { display: flex; align-items: center; gap: 0.875rem; font-size: 0.9rem; line-height: 1.4; padding: 0.75rem 0; border-bottom: 1px solid var(--border); transition: background 0.15s; }
    .recent-activity-item:last-child { border-bottom: none; }
    .recent-activity-item:hover { background: var(--accent-soft); margin: 0 -1rem; padding-left: 1rem; padding-right: 1rem; border-radius: 10px; }
    .recent-activity-item .activity-avatar { width: 42px; height: 42px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), #a855f7); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.95rem; flex-shrink: 0; overflow: hidden; box-shadow: 0 2px 8px rgba(201, 112, 130, 0.3); }
    .recent-activity-item .activity-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .recent-activity-item .activity-body { flex: 1; min-width: 0; }
    .recent-activity-item .activity-name { font-weight: 500; display: block; }
    .recent-activity-item .activity-text { font-size: 0.9rem; }
    .recent-activity-item .activity-meta { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.15rem; }
    .recent-activity-empty { font-size: 0.9rem; color: var(--text-muted); padding: 0.5rem 0; }
    .top-spenders-card { margin-top: 1.5rem; }
    .top-spenders-list { display: flex; flex-direction: column; gap: 0; }
    .top-spenders-item { display: flex; align-items: center; gap: 0.875rem; font-size: 0.9rem; padding: 0.65rem 0; border-bottom: 1px solid var(--border); transition: background 0.15s; }
    .top-spenders-item:last-child { border-bottom: none; }
    .top-spenders-item:hover { background: var(--accent-soft); margin: 0 -1rem; padding-left: 1rem; padding-right: 1rem; border-radius: 10px; }
    .top-spenders-item .spender-avatar { width: 42px; height: 42px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), #a855f7); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.95rem; flex-shrink: 0; box-shadow: 0 2px 8px rgba(201, 112, 130, 0.3); }
    .top-spenders-item .spender-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    .top-spenders-item .spender-info { flex: 1; min-width: 0; }
    .top-spenders-item .spender-name { font-weight: 500; display: block; }
    .top-spenders-item .spender-email { font-size: 0.8rem; color: var(--text-muted); }
    .top-spenders-item .spender-amount { font-weight: 600; color: var(--accent); white-space: nowrap; }
    .top-spenders-item.top-spenders-item-more { display: none; }
    .top-spenders-card.expanded .top-spenders-item-more { display: flex; }
    .top-spenders-toggle { margin-top: 0.75rem; font-size: 0.85rem; color: var(--accent); background: none; border: none; cursor: pointer; padding: 0.25rem 0; font-family: inherit; font-weight: 500; }
    .top-spenders-toggle:hover { text-decoration: underline; }
    .top-purchases-card { margin-top: 1.5rem; }
    .top-purchases-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .top-purchases-table th { text-align: left; padding: 0.6rem 0.5rem 0.6rem 0; font-weight: 600; font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.04em; border-bottom: 1px solid var(--border); }
    .top-purchases-table td { padding: 0.65rem 0.5rem 0.65rem 0; border-bottom: 1px solid var(--border); transition: background 0.15s; }
    .top-purchases-table tbody tr:hover td { background: var(--accent-soft); }
    .top-purchases-table tr:last-child td { border-bottom: none; }
    .top-purchases-table .purchase-revenue { font-weight: 600; color: var(--accent); }
    .top-purchases-note { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.75rem; line-height: 1.4; }
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1.25rem; }
    .metrics-grid .stat-card .value { font-size: 1.35rem; }
  </style>
</head>
<body>
  <header class="admin-header">
    <a href="dashboard.html" class="admin-header-title">Admin Dashboard</a>
    <div class="admin-header-right">
      <a href="/home" class="header-link" target="_blank" rel="noopener" title="Home">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      </a>
      <div class="admin-header-profile" id="admin-header-profile">
        <button type="button" class="profile-btn" id="admin-profile-btn" aria-haspopup="true" aria-expanded="false" title="Profile menu">
          <span id="admin-profile-avatar" class="profile-btn-default" aria-hidden="true"></span>
        </button>
        <div class="profile-dropdown">
          <a href="/profile" target="_blank" rel="noopener">Your profile</a>
          <a href="mailto:stormijxo@gmail.com?subject=Report%20a%20problem" id="report-problem-link">Report a problem</a>
          <button type="button" id="btn-logout">Log out</button>
        </div>
      </div>
    </div>
  </header>

  <nav class="admin-tabs-bar" aria-label="Dashboard sections">
    <button type="button" class="tab active" data-panel="overview">Overview</button>
    <a href="users.html" class="tab">Users</a>
    <button type="button" class="tab" data-panel="tools">Tools</button>
  </nav>

  <main class="admin-main custom-scrollbar" role="main">
    <div class="admin-main-inner">
      <section id="panel-overview" class="panel active">
        <p id="overview-loading" class="loading-stats">Loading…</p>

        <div class="overview-section">
          <h2 class="overview-section-title">Audience</h2>
          <div class="overview-cards">
            <div class="stat-card">
              <div class="label">Total members</div>
              <div class="value" id="stat-total-users">—</div>
              <div class="sublabel">Paying subscribers</div>
            </div>
            <div class="stat-card">
              <div class="label">New members (30d)</div>
              <div class="value" id="stat-new-users">—</div>
            </div>
          </div>
        </div>

        <div class="overview-section">
          <h2 class="overview-section-title">Total revenue</h2>
          <div class="overview-cards">
            <div class="stat-card revenue-total">
              <div class="label">Tips + subscriptions + store</div>
              <div class="value" id="stat-total-revenue">—</div>
            </div>
          </div>
        </div>

        <div class="overview-section">
          <h2 class="overview-section-title">Spend metrics to track</h2>
          <div class="overview-cards metrics-grid">
            <div class="stat-card">
              <div class="label">Revenue (30d)</div>
              <div class="value" id="metric-revenue-30d">—</div>
              <div class="sublabel">Rolling monthly trend</div>
            </div>
            <div class="stat-card">
              <div class="label">Avg order value</div>
              <div class="value" id="metric-avg-order">—</div>
              <div class="sublabel">Total revenue ÷ transactions</div>
            </div>
            <div class="stat-card">
              <div class="label">Repeat buyers</div>
              <div class="value" id="metric-repeat-buyers">—</div>
              <div class="sublabel">Tips or store more than once</div>
            </div>
            <div class="stat-card">
              <div class="label">Refunds</div>
              <div class="value" id="metric-refunds">—</div>
              <div class="sublabel">Track when you add refunds</div>
            </div>
          </div>
        </div>

        <div class="overview-section">
          <h2 class="overview-section-title">Activity &amp; performance</h2>
          <div class="overview-layout">
            <div>
              <div class="recent-activity-card">
                <h2>Recent activity</h2>
                <div id="recent-activity-list" class="recent-activity-list">
                  <span class="recent-activity-empty">Loading…</span>
                </div>
              </div>
              <div class="top-spenders-card" id="top-spenders-card">
                <h2>Top spenders</h2>
                <div id="top-spenders-list" class="top-spenders-list">
                  <span class="recent-activity-empty">Loading…</span>
                </div>
                <button type="button" id="top-spenders-toggle" class="top-spenders-toggle" style="display: none;">View more</button>
              </div>
            </div>
            <div class="top-purchases-card" id="top-purchases-card">
              <h2>Top purchases</h2>
              <p class="top-purchases-note" style="margin-bottom:0.75rem;">Store: personal messages, 1-on-1 chat, video &amp; voice calls</p>
              <table class="top-purchases-table" id="top-purchases-table">
                <thead>
                  <tr><th>Product</th><th>Purchases</th><th>Revenue</th></tr>
                </thead>
                <tbody id="top-purchases-tbody"></tbody>
              </table>
              <p class="top-purchases-note" id="top-purchases-note">Store coming soon. Real data will appear when you add a purchases collection.</p>
            </div>
          </div>
        </div>
      </section>

      <section id="panel-tools" class="panel">
        <div class="tools-list">
          <a href="media.html">Media</a>
          <a href="content.html">Content</a>
          <a href="posts.html">Posts</a>
        </div>
      </section>
    </div>
    </main>

  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="../firebase-config.js"></script>
  <script src="admin-auth.js"></script>
  <script>
    if (typeof FIREBASE_CONFIG === "undefined" || !FIREBASE_CONFIG.apiKey || FIREBASE_CONFIG.apiKey === "YOUR_API_KEY") {
      document.body.innerHTML = "<main class='admin-main' style='padding:2rem'><h1>Firebase not configured</h1><p>Edit <code>firebase-config.js</code> and add your config.</p></main>";
    } else {
      firebase.initializeApp(FIREBASE_CONFIG);
      var auth = firebase.auth();
      var db = firebase.firestore();

      ensureAdminAccess(function(user) {
        if (!user) return;
        if (typeof window.applyAdminHeaderAvatar === "function") window.applyAdminHeaderAvatar(user);
        loadOverviewStats();
        loadRecentActivity();
        loadRevenueAndMetrics();
        loadTopPurchases();
      });

      document.getElementById("btn-logout").addEventListener("click", function() {
        auth.signOut();
      });

      (function() {
        var profile = document.getElementById("admin-header-profile");
        var btn = document.getElementById("admin-profile-btn");
        if (!profile || !btn) return;
        btn.addEventListener("click", function(e) {
          e.stopPropagation();
          profile.classList.toggle("open");
          btn.setAttribute("aria-expanded", profile.classList.contains("open"));
        });
        document.addEventListener("click", function() {
          profile.classList.remove("open");
          btn.setAttribute("aria-expanded", "false");
        });
      })();

      // Tab switching (Overview / Tools)
      document.querySelectorAll(".admin-tabs-bar .tab[data-panel]").forEach(function(btn) {
        btn.addEventListener("click", function() {
          var panelId = btn.getAttribute("data-panel");
          document.querySelectorAll(".admin-main .panel").forEach(function(p) { p.classList.remove("active"); });
          document.querySelectorAll(".admin-tabs-bar .tab").forEach(function(t) { t.classList.remove("active"); });
          var panel = document.getElementById("panel-" + panelId);
          if (panel) panel.classList.add("active");
          btn.classList.add("active");
        });
      });

      function loadOverviewStats() {
        var totalEl = document.getElementById("stat-total-users");
        var newEl = document.getElementById("stat-new-users");
        var loadingEl = document.getElementById("overview-loading");
        var cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - 30);

        db.collection("members").get().then(function(snap) {
          var total = snap.size;
          var newCount = 0;
          snap.forEach(function(doc) {
            var d = doc.data();
            var joined = d.joinedAt && d.joinedAt.toDate ? d.joinedAt.toDate() : null;
            if (joined && joined >= cutoff) newCount++;
          });
          if (totalEl) totalEl.textContent = total;
          if (newEl) newEl.textContent = newCount;
          if (loadingEl) loadingEl.style.display = "none";
        }).catch(function(err) {
          if (totalEl) totalEl.textContent = "—";
          if (newEl) newEl.textContent = "—";
          if (loadingEl) { loadingEl.textContent = "Error loading stats."; loadingEl.style.display = "block"; }
        });
      }

      function loadRecentActivity() {
        var container = document.getElementById("recent-activity-list");
        if (!container) return;
        var siteName = "My Inner circle";
        db.collection("members")
          .orderBy("joinedAt", "desc")
          .limit(15)
          .get()
          .then(function(snap) {
            container.innerHTML = "";
            if (snap.empty) {
              container.innerHTML = "<span class='recent-activity-empty'>No members yet.</span>";
              return;
            }
            snap.forEach(function(doc) {
              var d = doc.data();
              var name = (d.displayName || d.instagram_handle || d.note || d.email || "Member").toString().trim();
              if (name.indexOf("@") === 0) name = name.slice(1);
              var initial = (name.charAt(0) || "?").toUpperCase();
              var photoUrl = d.avatarUrl || d.photoURL || null;
              var avatarHtml = photoUrl
                ? "<img src=\"" + escapeHtml(photoUrl) + "\" alt=\"\" />"
                : escapeHtml(initial);
              var dateStr = "—";
              if (d.joinedAt && d.joinedAt.toDate) {
                dateStr = d.joinedAt.toDate().toLocaleString(undefined, { month: "numeric", day: "numeric", year: "numeric", hour: "2-digit", minute: "2-digit", second: "2-digit" });
              }
              var item = document.createElement("div");
              item.className = "recent-activity-item";
              item.innerHTML =
                "<div class='activity-avatar'>" + avatarHtml + "</div>" +
                "<div class='activity-body'>" +
                  "<span class='activity-name'>" + escapeHtml(name) + "</span>" +
                  "<span class='activity-text'> joined " + escapeHtml(siteName) + "</span>" +
                  "<div class='activity-meta'>" + escapeHtml(dateStr) + "</div>" +
                "</div>";
              container.appendChild(item);
            });
          })
          .catch(function(err) {
            container.innerHTML = "<span class='recent-activity-empty'>Error loading activity.</span>";
          });
      }

      function escapeHtml(s) {
        var div = document.createElement("div");
        div.textContent = s;
        return div.innerHTML;
      }

      function loadTopPurchases() {
        var tbody = document.getElementById("top-purchases-tbody");
        var noteEl = document.getElementById("top-purchases-note");
        if (!tbody) return;
        db.collection("purchases").get().then(function(snap) {
          if (!snap.empty) {
            var byProduct = {};
            snap.forEach(function(doc) {
              var d = doc.data();
              var name = (d.productName || d.productId || d.sku || "Purchase").toString();
              var cents = typeof d.amountCents === "number" ? d.amountCents : (typeof d.amount === "number" ? Math.round(d.amount * 100) : 0);
              if (!byProduct[name]) byProduct[name] = { count: 0, cents: 0 };
              byProduct[name].count += 1;
              byProduct[name].cents += cents;
            });
            var rows = Object.keys(byProduct).map(function(k) { return { name: k, count: byProduct[k].count, cents: byProduct[k].cents }; }).sort(function(a, b) { return b.cents - a.cents; });
            tbody.innerHTML = "";
            rows.forEach(function(r) {
              var tr = document.createElement("tr");
              tr.innerHTML = "<td>" + escapeHtml(r.name) + "</td><td>" + r.count + "</td><td class='purchase-revenue'>$" + (r.cents / 100).toFixed(2) + "</td>";
              tbody.appendChild(tr);
            });
            if (noteEl) noteEl.textContent = "From your store. Add more products to see them here.";
            return;
          }
          var demo = [
            { product: "1-on-1 Chat", purchases: 12, revenue: 240 },
            { product: "Video Call", purchases: 8, revenue: 400 },
            { product: "Personal Message", purchases: 24, revenue: 120 },
          ];
          tbody.innerHTML = "";
          demo.forEach(function(r) {
            var tr = document.createElement("tr");
            tr.innerHTML = "<td>" + escapeHtml(r.product) + "</td><td>" + r.purchases + "</td><td class='purchase-revenue'>$" + r.revenue + ".00</td>";
            tbody.appendChild(tr);
          });
          if (noteEl) noteEl.textContent = "Store coming soon (1-on-1, video calls, etc.). Real data will appear here when you add a purchases collection.";
        }).catch(function() {
          var demo = [
            { product: "1-on-1 Chat", purchases: 12, revenue: 240 },
            { product: "Video Call", purchases: 8, revenue: 400 },
            { product: "Personal Message", purchases: 24, revenue: 120 },
          ];
          tbody.innerHTML = "";
          demo.forEach(function(r) {
            var tr = document.createElement("tr");
            tr.innerHTML = "<td>" + escapeHtml(r.product) + "</td><td>" + r.purchases + "</td><td class='purchase-revenue'>$" + r.revenue + ".00</td>";
            tbody.appendChild(tr);
          });
          if (noteEl) noteEl.textContent = "Store coming soon. Real data will appear when you add a purchases collection.";
        });
      }

      var topSpendersToggleBound = false;
      function renderTopSpenders(sorted, listEl, toggleBtn, cardEl) {
        if (!listEl) return;
        function row(o, i, showCount) {
          var name = (o.name || o.email || "—").toString().trim();
          if (name.indexOf("@") === 0) name = name.slice(1);
          var initial = (name.charAt(0) || "?").toUpperCase();
          var amountStr = "$" + (o.totalCents / 100).toFixed(2);
          var item = document.createElement("div");
          item.className = "top-spenders-item" + (i >= showCount ? " top-spenders-item-more" : "");
          item.innerHTML =
            "<div class='spender-avatar'>" + escapeHtml(initial) + "</div>" +
            "<div class='spender-info'><span class='spender-name'>" + escapeHtml(name) + "</span><span class='spender-email'>" + escapeHtml(o.email) + "</span></div>" +
            "<span class='spender-amount'>" + escapeHtml(amountStr) + "</span>";
          listEl.appendChild(item);
        }
        var demo = [
          { email: "alex.rivera@example.com", name: "Alex Rivera", totalCents: 12500 },
          { email: "jordan.lee@example.com", name: "Jordan Lee", totalCents: 8500 },
          { email: "sam.taylor@example.com", name: "Sam Taylor", totalCents: 5200 },
        ];
        listEl.innerHTML = "";
        var showCount = 3;
        if (!sorted || sorted.length === 0) {
          demo.forEach(function(o, i) { row(o, i, showCount); });
          if (toggleBtn) { toggleBtn.style.display = "none"; }
          if (cardEl) cardEl.classList.remove("expanded");
          return;
        }
        sorted.forEach(function(o, i) { row(o, i, showCount); });
        if (toggleBtn) {
          toggleBtn.style.display = sorted.length > showCount ? "block" : "none";
          toggleBtn.textContent = "View more";
        }
        if (cardEl) cardEl.classList.remove("expanded");
      }

      function loadRevenueAndMetrics() {
        var tipsTotalCents = 0, tips30dCents = 0, tipsCount = 0, repeatTippers = 0;
        var byEmail = {};
        var storeTotalCents = 0, store30dCents = 0, storeCount = 0;
        var cutoff30 = new Date();
        cutoff30.setDate(cutoff30.getDate() - 30);

        function setEl(id, text) {
          var el = document.getElementById(id);
          if (el) el.textContent = text;
        }

        function finish() {
          var totalRevenue = tipsTotalCents + storeTotalCents;
          var revenue30d = tips30dCents + store30dCents;
          var totalTx = tipsCount + storeCount;
          var repeatBuyers = repeatTippers;

          setEl("stat-total-revenue", totalRevenue > 0 ? "$" + (totalRevenue / 100).toFixed(2) : "$0.00");
          setEl("metric-revenue-30d", revenue30d > 0 ? "$" + (revenue30d / 100).toFixed(2) : "$0.00");
          setEl("metric-avg-order", totalTx > 0 && totalRevenue > 0 ? "$" + (totalRevenue / 100 / totalTx).toFixed(2) : "—");
          setEl("metric-repeat-buyers", repeatBuyers > 0 ? repeatBuyers : "0");
          setEl("metric-refunds", "—");

          var sorted = Object.keys(byEmail).map(function(k) { return byEmail[k]; }).filter(function(o) { return o.totalCents > 0; }).sort(function(a, b) { return b.totalCents - a.totalCents; });
          renderTopSpenders(sorted, document.getElementById("top-spenders-list"), document.getElementById("top-spenders-toggle"), document.getElementById("top-spenders-card"));
        }

        Promise.all([
          db.collection("tips").get(),
          db.collection("purchases").get().catch(function() { return { empty: true, forEach: function() {} }; })
        ]).then(function(results) {
          var tipsSnap = results[0];
          var purchasesSnap = results[1];

          tipsSnap.forEach(function(doc) {
            var d = doc.data();
            var cents = typeof d.amountCents === "number" ? d.amountCents : 0;
            tipsTotalCents += cents;
            tipsCount += 1;
            var tippedAt = d.tippedAt && d.tippedAt.toDate ? d.tippedAt.toDate() : null;
            if (tippedAt && tippedAt >= cutoff30) tips30dCents += cents;
            var email = (d.email || "").toString().trim().toLowerCase();
            if (!email) return;
            if (!byEmail[email]) {
              byEmail[email] = { email: d.email || email, name: d.instagram_handle || d.email || email, totalCents: 0, count: 0 };
            }
            byEmail[email].totalCents += cents;
            byEmail[email].count += 1;
            if (d.instagram_handle && !byEmail[email].name) byEmail[email].name = d.instagram_handle;
          });
          Object.keys(byEmail).forEach(function(e) {
            if (byEmail[e].count > 1) repeatTippers++;
          });

          if (!purchasesSnap.empty && purchasesSnap.forEach) {
            purchasesSnap.forEach(function(doc) {
              var d = doc.data();
              var cents = typeof d.amountCents === "number" ? d.amountCents : (typeof d.amount === "number" ? Math.round(d.amount * 100) : 0);
              storeTotalCents += cents;
              storeCount += 1;
              var createdAt = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : (d.purchasedAt && d.purchasedAt.toDate ? d.purchasedAt.toDate() : null);
              if (createdAt && createdAt >= cutoff30) store30dCents += cents;
            });
          }

          finish();
        }).catch(function() {
          setEl("stat-total-revenue", "—");
          setEl("metric-revenue-30d", "—");
          setEl("metric-avg-order", "—");
          setEl("metric-repeat-buyers", "—");
          setEl("metric-refunds", "—");
          renderTopSpenders(null, document.getElementById("top-spenders-list"), document.getElementById("top-spenders-toggle"), document.getElementById("top-spenders-card"));
        });

        if (!topSpendersToggleBound) {
          topSpendersToggleBound = true;
          var toggleBtn = document.getElementById("top-spenders-toggle");
          var cardEl = document.getElementById("top-spenders-card");
          if (toggleBtn && cardEl) {
            toggleBtn.addEventListener("click", function() {
              if (cardEl.classList.contains("expanded")) {
                cardEl.classList.remove("expanded");
                toggleBtn.textContent = "View more";
              } else {
                cardEl.classList.add("expanded");
                toggleBtn.textContent = "Show less";
              }
            });
          }
        }
      }
    }
  </script>
</body>
</html>
