<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin login — My Inner circle</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../styles.css" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><circle fill='%23c97082' cx='16' cy='16' r='14'/></svg>" type="image/svg+xml" />
  <style>
    .login-page { max-width: 360px; margin: 4rem auto; padding: 2rem; }
    .login-page h1 { font-size: 1.5rem; margin-bottom: 1.5rem; }
    .login-form label { display: block; margin-bottom: 0.35rem; font-weight: 500; }
    .login-form input { width: 100%; padding: 0.65rem; margin-bottom: 1rem; border: 1px solid var(--border); border-radius: 8px; }
    .password-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
    .password-row input { margin-bottom: 0; flex: 1; }
    .btn-password-toggle {
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text-muted);
      border-radius: 8px;
      padding: 0.65rem 0.75rem;
      cursor: pointer;
      font-size: 0.85rem;
      white-space: nowrap;
    }
    .btn-password-toggle:hover { color: var(--accent); border-color: var(--accent); }
    .login-form .btn { width: 100%; margin-top: 0.5rem; }
    .login-error { color: #c53030; font-size: 0.9rem; margin-bottom: 1rem; display: none; }
    .login-error.visible { display: block; }
    .back-link { display: inline-block; margin-top: 1rem; font-size: 0.9rem; color: var(--text-muted); }
    .login-header { display: flex; justify-content: center; align-items: center; border-bottom: 1px solid var(--border); }
    .login-header .logo { display: block; line-height: 0; }
    .login-header .logo .logo-img { display: block; width: 240px !important; height: 64px !important; min-width: 200px !important; object-fit: contain; }
  </style>
</head>
<body>
  <header class="login-header">
    <a href="/" class="logo logo-pop"><img src="../assets/logo.svg" alt="My Inner circle" class="logo-img" /></a>
  </header>
  <main class="login-page">
    <h1>My Inner circle — Admin</h1>
    <p id="login-error" class="login-error"></p>
    <form id="login-form" class="login-form">
      <label for="email">Email</label>
      <input type="email" id="email" required autocomplete="email" />
      <label for="password">Password</label>
      <div class="password-row">
        <input type="password" id="password" required autocomplete="current-password" />
        <button type="button" id="toggle-password" class="btn-password-toggle" aria-controls="password" aria-label="Show password">Show</button>
      </div>
      <button type="submit" class="btn btn-primary">Log in</button>
    </form>
    <a href="/" class="back-link">← Back to site</a>
  </main>

  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="../firebase-config.js"></script>
  <script>
    if (typeof FIREBASE_CONFIG === "undefined" || !FIREBASE_CONFIG.apiKey || FIREBASE_CONFIG.apiKey === "YOUR_API_KEY") {
      document.body.innerHTML = "<main class='login-page'><h1>Firebase not configured</h1><p>Edit <code>firebase-config.js</code> in the project root and add your Firebase project config.</p><a href='/' class='back-link'>← Back to site</a></main>";
    } else {
      firebase.initializeApp(FIREBASE_CONFIG);
      var auth = firebase.auth();
      var db = firebase.firestore();

      // Temporary: these emails can always access admin until they're added in User Management
      var ALLOWED_ADMIN_EMAILS = ["will_jackson@icloud.com", "stormijxo@gmail.com"];

      function checkAdminAndRedirect(email) {
        var emailNorm = (email || "").trim().toLowerCase();
        if (ALLOWED_ADMIN_EMAILS.indexOf(emailNorm) !== -1) {
          window.location.href = "dashboard.html";
          return;
        }
        db.collection("admin_users").where("role", "==", "admin").limit(1).get()
          .then(function(adminCountSnap) {
            if (adminCountSnap.empty) {
              window.location.href = "dashboard.html";
              return null;
            }
            return db.collection("admin_users").where("email", "==", email).where("role", "==", "admin").limit(1).get();
          })
          .then(function(snap) {
            if (snap === null) return;
            if (snap && !snap.empty) window.location.href = "dashboard.html";
            else {
              auth.signOut();
              var errEl = document.getElementById("login-error");
              errEl.textContent = "You don't have admin access. Your email must be in User Management with role Admin.";
              errEl.classList.add("visible");
            }
          })
          .catch(function() { window.location.href = "dashboard.html"; });
      }

      auth.onAuthStateChanged(function(user) {
        if (user) checkAdminAndRedirect(user.email);
      });
      var reason = new URLSearchParams(window.location.search).get("reason");
      if (reason === "noaccess") {
        document.getElementById("login-error").textContent = "You don't have admin access.";
        document.getElementById("login-error").classList.add("visible");
      }

      var passwordInput = document.getElementById("password");
      var togglePasswordBtn = document.getElementById("toggle-password");
      if (passwordInput && togglePasswordBtn) {
        togglePasswordBtn.addEventListener("click", function() {
          var show = passwordInput.type === "password";
          passwordInput.type = show ? "text" : "password";
          togglePasswordBtn.textContent = show ? "Hide" : "Show";
          togglePasswordBtn.setAttribute("aria-label", show ? "Hide password" : "Show password");
        });
      }

      document.getElementById("login-form").addEventListener("submit", function(e) {
        e.preventDefault();
        var email = document.getElementById("email").value.trim();
        var password = document.getElementById("password").value;
        var errEl = document.getElementById("login-error");
        errEl.textContent = "";
        errEl.classList.remove("visible");
        auth.signInWithEmailAndPassword(email, password)
          .then(function() { checkAdminAndRedirect(email); })
          .catch(function(err) {
            errEl.textContent = err.message || "Login failed.";
            errEl.classList.add("visible");
          });
      });
    }
  </script>
</body>
</html>
